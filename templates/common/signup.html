{% extends "base.html" %}
{% load static %}
{% block content %}
<div id="signup-result" class="mt-3 text-success"></div>
<div class="container my-3">
    <form id="signup-form" method="post" action="{% url 'common:signup' %}">
        {% csrf_token %}

        {% include "form_errors.html" %}
        <div class="mb-3">
            <label for="user_id">아이디</label>
            <input type="text" class="form-control" name="user_id" id="user_id" placeholder="아이디">
        </div>
        <div class="mb-3">
            <label for="password">비밀번호</label>
            <input type="password" class="form-control" name="password" id="password"
                    value="{{ form.password1.value|default_if_none:'' }}">
        </div>
        <div class="mb-3">
            <label for="name">이름</label>
            <input type="text" class="form-control" name="name" id="name" placeholder="이름">
        </div>
        <div class="mb-3">
            <label for="age">또래</label>
            <input type="number" class="form-control" name="age" id="age" placeholder="또래">
        </div>
        <div class="mb-3">
            <label for="org">마을</label>
            <input type="text" class="form-control" name="org" id="org" placeholder="마을">
        </div>
        <div class="mb-3">
            <label for="gender">성별</label>
            <input type="radio" name="gender" id="genderM" value="M"> 남
            <input type="radio" name="gender" id="genderF" value="F"> 여
        </div>
        <div class="mb-3">
            <label for="phone">연락처</label>
            <input type="text" class="form-control" name="phone" id="phone" placeholder="연락처">
        </div>

        <!-- <div class="mb-3">
            <label for="password2">비밀번호 확인</label>
            <input type="password" class="form-control" name="password2" id="password2"
                    value="{{ form.password2.value|default_if_none:'' }}">
        </div> -->
        
        <input name="anon_id" id="anon_id" hidden>
        <input name="public_key" id="public_key" hidden>
        <input name="encrypted_name" id="encrypted_name" hidden>
        <input name="encrypted_privkey" id="encrypted_privkey" hidden>
        <input name="encrypted_age" id="encrypted_age" hidden>
        <input name="encrypted_org" id="encrypted_org" hidden>
        <input name="encrypted_phone" id="encrypted_phone" hidden>
        <input name="profile_tag" id="profile_tag" hidden>
        <input name="salt" id="salt" hidden>
        <!-- <div class="mb-3">
            <label for="email">이메일</label>
            <input type="text" class="form-control" name="email" id="email"
                    value="{{ form.email.value|default_if_none:'' }}">
        </div> -->
        <button type="submit" class="btn btn-primary">가입하기</button>
    </form>
</div>
{% endblock %}
{% block script %}
<script type="module">
import {
    hmacSign,
    generateRsaKeyPair, exportRsaPublicKey,
    rsaEncrypt,
    deriveAesKey, aesEncrypt, aesDecrypt, getAesKey
} from "{% static 'crypto_utils.js' %}";

(async () => {

    // 서버에서 전달받은 HMAC에 사용할 serverSecret (변경 없음)
    const serverSecretB64 = "{{ server_secret_b64 }}";
    const form = document.getElementById('signup-form');

    // 고정 salt 값
    const userSaltB64 = "{{ user_salt }}";
    const salt = Uint8Array.from(atob(userSaltB64), c => c.charCodeAt(0));
    
    form.addEventListener('submit', async e => {
        e.preventDefault();  // 기본 제출 막기

        // 0) 비밀번호 읽기 (pw 변수 추가)
        const pw = form.elements.password.value;

        // 1) HMAC key 생성 (단방향)


        // 1-1) ID 암호화 using HMAC
        const userId = form.elements.user_id.value;
        const anonId = await hmacSign(userId,serverSecretB64);
        document.getElementById('anon_id').value = anonId;

        // 1-2) profile_tag 암호화 using HAMC
        const profileJson = JSON.stringify({
            name: form.elements.name.value,
            age: form.elements.age.value,
            org: form.elements.org.value
        });
        document.getElementById('profile_tag').value = await hmacSign(profileJson,serverSecretB64);

        // 2) RSA 키 쌍 한 번만 생성(복호화용)
        const { publicKey, privateKey } = await generateRsaKeyPair();
        document.getElementById('public_key').value = await exportRsaPublicKey(publicKey);

        // 3) PBKDF2 -> AES-GCM 키 생성 및 개인키 암호화
        const aesKey = await deriveAesKey(pw, salt);
        const privBuf = await crypto.subtle.exportKey('pkcs8', privateKey);
        const privB64 = btoa(String.fromCharCode(...new Uint8Array(privBuf)));
        // console.log('priv before aes enc: ', privB64);
        const afterenc = await aesEncrypt(privB64, aesKey);
        document.getElementById('encrypted_privkey').value = afterenc;
        // console.log('priv after aes enc: ', afterenc);
        // const privB642 = await aesDecrypt(afterenc, aesKey); 
        // console.log('priv after aes descrypt: ', privB642);

        // 4) 이름, 나이, 소속, 연락처 : AES-GCM 암호화
        document.getElementById('encrypted_name').value = await aesEncrypt(form.elements.name.value, aesKey);
        document.getElementById('encrypted_age').value = await aesEncrypt(form.elements.age.value, aesKey);
        document.getElementById('encrypted_org').value = await aesEncrypt(form.elements.org.value, aesKey);
        document.getElementById('encrypted_phone').value = await aesEncrypt(form.elements.phone.value, aesKey);
        document.getElementById('salt').value = userSaltB64;

        // ④ HTMX로 AJAX 요청 (한 번만)
        const fd = new FormData(form);
        const csrf = fd.get('csrfmiddlewaretoken');
        htmx.ajax('POST', form.action, {
            headers: { 'X-CSRFToken': csrf },
            values: Object.fromEntries(fd.entries()),
            target: '#signup-result',
            swap: 'innerHTML'
        });
    });
})();
</script>
{% endblock %}