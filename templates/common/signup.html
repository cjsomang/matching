{% extends "base.html" %}
{% block content %}
<div id="signup-result" class="mt-3 text-success"></div>
<div class="container my-3">
    <form id="signup-form" method="post" action="{% url 'common:signup' %}">
        {% csrf_token %}

        {% include "form_errors.html" %}
        <div class="mb-3">
            <label for="user_id">아이디</label>
            <input type="text" class="form-control" name="user_id" id="user_id" placeholder="아이디">
        </div>
        <div class="mb-3">
            <label for="password">비밀번호</label>
            <input type="password" class="form-control" name="password" id="password"
                    value="{{ form.password1.value|default_if_none:'' }}">
        </div>
        <div class="mb-3">
            <label for="name">이름</label>
            <input type="text" class="form-control" name="name" id="name" placeholder="이름">
        </div>
        <div class="mb-3">
            <label for="age">또래</label>
            <input type="number" class="form-control" name="age" id="age" placeholder="또래">
        </div>
        <div class="mb-3">
            <label for="org">마을</label>
            <input type="text" class="form-control" name="org" id="org" placeholder="마을">
        </div>
        <div class="mb-3">
            <label for="gender">성별</label>
            <input type="radio" name="gender" id="genderM" value="M"> 남
            <input type="radio" name="gender" id="genderF" value="F"> 여
        </div>
        <div class="mb-3">
            <label for="phone">연락처</label>
            <input type="text" class="form-control" name="phone" id="phone" placeholder="연락처">
        </div>

        <!-- <div class="mb-3">
            <label for="password2">비밀번호 확인</label>
            <input type="password" class="form-control" name="password2" id="password2"
                    value="{{ form.password2.value|default_if_none:'' }}">
        </div> -->
        
        <input name="anon_id" id="anon_id" hidden>
        <input name="public_key" id="public_key" hidden>
        <input name="encrypted_name" id="encrypted_name" hidden>
        <input name="encrypted_age" id="encrypted_age" hidden>
        <input name="encrypted_org" id="encrypted_org" hidden>
        <input name="encrypted_phone" id="encrypted_phone" hidden>
        <!-- <div class="mb-3">
            <label for="email">이메일</label>
            <input type="text" class="form-control" name="email" id="email"
                    value="{{ form.email.value|default_if_none:'' }}">
        </div> -->
        <button type="submit" class="btn btn-primary">생성하기</button>
    </form>
</div>
{% endblock %}
{% block script %}
<script>
    (async () => {
        const serverSecretB64 = "{{ server_secret_b64 }}";
        const serverSecret = Uint8Array.from(atob(serverSecretB64), c => c.charCodeAt(0));

        // ① 페이지 로드 시 RSA 키 쌍 한 번만 생성
        const kp = await crypto.subtle.generateKey(
            {
                name: 'RSA-OAEP', modulusLength: 2048,
                publicExponent: new Uint8Array([1, 0, 1]), hash: 'SHA-256'
            },
            true, ['encrypt', 'decrypt']
        );
        const spki = await crypto.subtle.exportKey('spki', kp.publicKey);
        const b64pub = btoa(String.fromCharCode(...new Uint8Array(spki)));
        document.getElementById('public_key').value =
            `-----BEGIN PUBLIC KEY-----\n${b64pub.match(/.{1,64}/g).join('\n')}\n-----END PUBLIC KEY-----`;

        const form = document.getElementById('signup-form');
        form.addEventListener('submit', async e => {
            e.preventDefault();  // 기본 제출 막기

            // ② user_id → anon_id (HMAC)
            const userId = form.elements.user_id.value;
            const hmacKey = await crypto.subtle.importKey(
                'raw', serverSecret, { name: 'HMAC', hash: 'SHA-256' },
                false, ['sign']
            );
            const sig = await crypto.subtle.sign(
                'HMAC', hmacKey,
                new TextEncoder().encode(userId)
            );
            document.getElementById('anon_id').value =
                btoa(String.fromCharCode(...new Uint8Array(sig)));

            // ③ 프로필 각 필드 암호화 함수
            const enc = async (value) => {
                const buf = await crypto.subtle.encrypt(
                    { name: 'RSA-OAEP' },
                    kp.publicKey,
                    new TextEncoder().encode(value)
                );
                return btoa(String.fromCharCode(...new Uint8Array(buf)));
            };

            document.getElementById('encrypted_name').value = await enc(form.elements.name.value);
            document.getElementById('encrypted_age').value = await enc(form.elements.age.value);
            document.getElementById('encrypted_org').value = await enc(form.elements.org.value);
            document.getElementById('encrypted_phone').value = await enc(form.elements.phone.value);

            // ④ HTMX로 AJAX 요청 (한 번만)
            const fd = new FormData(form);
            const csrf = fd.get('csrfmiddlewaretoken');
            htmx.ajax('POST', form.action, {
                headers: { 'X-CSRFToken': csrf },
                values: Object.fromEntries(fd.entries()),
                target: '#signup-result',
                swap: 'innerHTML'
            });
        });
    })();
</script>
{% endblock %}