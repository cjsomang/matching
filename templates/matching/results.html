{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container my-3">
    <h2>ë§¤ì¹­ ê²°ê³¼</h2>
    <ul id="match-list">
        <!-- ì—¬ê¸°ì„œ ë§¤ì¹­ëœ í›„ë³´ì˜ ê³µê°œ í”„ë¡œí•„ ì •ë³´ë¥¼ ëª©ë¡ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤. -->
    </ul>
    <div id="contact-info" class="mt-3">
        <!-- ì—¬ì„±ì´ í›„ë³´ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ í›„ë³´ì˜ ì—°ë½ì²˜ë¥¼ í‘œì‹œ -->
    </div>
    <div id="no-matches" class="text-muted"></div>
    <form id="csrf-form">{% csrf_token %}</form>
</div>
{% endblock %}

{% block script %}
<script type="module">
import {
    hmacSign,
    generateRsaKeyPair, exportRsaPublicKey, importRsaPublicKey,
    rsaEncrypt, rsaDecrypt,
    deriveAesKey, aesEncrypt, aesDecrypt, getAesKey
} from "{% static 'crypto_utils.js' %}";    
    (async () => {
        const anon_id = "{{ anon_id }}";
        const csrf = document.querySelector('#csrf-form [name=csrfmiddlewaretoken]').value;
        

        // 1) ë¡œê·¸ì¸ ì‹œ ì„¸ì…˜ì— ì €ì¥ëœ AES í‚¤ êº¼ë‚´ê¸° Â· ì—†ìœ¼ë©´ ì¬ë¡œê·¸ì¸ ìœ ë„
        

        const key = await getAesKey(anon_id);

        // 2) ì„œë²„ì—ì„œ encrypted_choices ë°›ì•„ì™€ ë³µí˜¸í™”
        const resEnc = await fetch("{% url 'matching:choices_api' %}");
        const { encrypted_choices } = await resEnc.json();
        if (!encrypted_choices) {
            document.getElementById('no-matches').textContent = "ë‚´ê°€ ì„ íƒí•œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
            return;
        }
        const plainChoices = JSON.parse(await aesDecrypt(encrypted_choices, key));

        // 1) ì„œë²„ê°€ ì¤€ ë§¤ì¹­ ë¦¬ìŠ¤íŠ¸
        const res = await fetch("{% url 'matching:results_api' %}");
        const { matches } = await res.json();
        if (!matches.length) {
            document.getElementById('no-matches').textContent = "ë§¤ì¹­ëœ ìƒëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤.";
            return;
        }

        // 3) í‰ë¬¸ ê°ê°ìœ¼ë¡œ íƒœê·¸ ìƒì„± â†’ ì¼ì¹˜í•˜ëŠ” ì„œë²„ íƒœê·¸ ì°¾ì•„ í‘œì‹œ
        const serverSecretb64 = "{{ server_secret_b64 }}";

        const list = document.getElementById('match-list');
        list.innerHTML = '';
        for (let choice of plainChoices) {
            // console.log(JSON.stringify(choice));
            const tag = await hmacSign(JSON.stringify(choice), serverSecretb64);
            // console.log(tag);
            // ì„œë²„ê°€ ëŒë ¤ì¤€ matches ì¤‘ íƒœê·¸ê°€ ì¼ì¹˜í•˜ëŠ” í›„ë³´ ì°¾ê¸°
            const cand = matches.find(m => m.profile_tag === tag);
            if (!cand) continue;

            const li = document.createElement('li');
            li.innerHTML = `
                ${choice.name} (ë˜ë˜: ${choice.age}, ë§ˆì„: ${choice.org})
                <button class="btn btn-sm btn-outline-primary get-contact-btn"
                        data-candidate-id="${cand.candidate_id}" data-pubkey="${cand.public_key}">
                ì—°ë½ì²˜ ì „ë‹¬í•˜ê¸°
                </button>
            `;
            list.appendChild(li);
        }
        // if (!list.childElementCount) {
        //     list.innerHTML = '<li class="text-muted"> ë§¤ì¹­ëœ ìƒëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
        // }


        const res_in = await fetch("{% url 'matching:get_myinfo_api' %}");
        const mydata = await res_in.json();

        // console.log('my enc phone: ', mydata.encrypted_phone);

        if (!mydata.encrypted_phone || mydata.encrypted_phone.length < 20) {
            throw new Error("ì—°ë½ì²˜ ì•”í˜¸ë¬¸ í˜•ì‹ì´ ì´ìƒí•¨");
        }

        // ë‚´ ì—°ë½ì²˜ ë³µí˜¸í™”
        // console.log('ë‚´ AES í‚¤:', key);
        // console.log('ë‚´ ì•”í˜¸í™”ëœ privkey:', mydata.encrypted_privkey);
        let privB64;
        try {
            privB64 = await aesDecrypt(mydata.encrypted_privkey, key);
            // console.log('ë³µí˜¸í™”ëœ privB64:', privB64);
        } catch (err) {
            console.error("âŒ ê°œì¸í‚¤ ë³µí˜¸í™” ì‹¤íŒ¨:", err);
            return;
        }
        // const privKey = await aesDecrypt(mydata.encrypted_privkey, key);
        // console.log('ë‚´ priv í‚¤:', privKey);
        const privBytes = Uint8Array.from(atob(privB64), c => c.charCodeAt(0));

        // importKeyë¡œ RSAâ€‘OAEP privateKey ë³µì›
        const privateKey = await crypto.subtle.importKey(
            'pkcs8',
            privBytes.buffer,
            { name: 'RSA-OAEP', hash: 'SHA-256' },
            false,
            ['decrypt']
        );

        // console.log('ë³µì›ëœ RSA privateKey:', privateKey);

        // 2. ì—°ë½ì²˜ ë²„íŠ¼ í´ë¦­ ì‹œ
        document.getElementById('match-list').addEventListener('click', async e => {
            if (!e.target.classList.contains('get-contact-btn')) return;
            const candidateId = e.target.dataset.candidateId;
            const pubkeyPem = e.target.dataset.pubkey;
            // API í˜¸ì¶œ
            try {
                // ë‚´ ì—°ë½ì²˜ ë°›ê¸°


                console.log("encrypted_phone length:", mydata.encrypted_phone.length);
                console.log("decoded length:", atob(mydata.encrypted_phone).length);

                const phone = await aesDecrypt(mydata.encrypted_phone, key);

                // let phone;
                // try {
                //     phone = await rsaDecrypt(privateKey, mydata.encrypted_phone);
                // } catch(err) {
                //     console.log('ë³µí˜¸í™” ì‹¤íŒ¨')
                //     return
                // }
                console.log('ë³µí˜¸í™”ëœ ë²ˆí˜¸:', phone);

                // ë‚´ ì—°ë½ì²˜ ìƒëŒ€ ê³µê°œí‚¤ë¡œ ì•”í˜¸í™”
                const rsaPubKey = await importRsaPublicKey(pubkeyPem);
                const grantEnc_phone = await rsaEncrypt(rsaPubKey, phone);
                console.log('my phone: ', grantEnc_phone);

                const res = await fetch("{% url 'matching:grant_contact_api' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
                body: JSON.stringify({ to_user: candidateId, reencrypted_phone: grantEnc_phone })
            });

            } catch (err) {
                console.error("ì—°ë½ì²˜ ìš”ì²­/ë³µí˜¸í™” ì‹¤íŒ¨", err);
                alert("ì—°ë½ì²˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });

        // ìƒëŒ€ë°© ì—°ë½ì²˜ ë°›ì•„ì„œ ë³µí˜¸í™”
        // const res_contact = await fetch("{% url 'matching:get_granted_contact_api' %}");
        // try {
            // 1) POST í•´ì„œ ì €ì¥ & ì¬ì•”í˜¸í™”ëœ ì „í™”ë²ˆí˜¸ ë°›ê¸°
            const res_contact = await fetch("{% url 'matching:grant_contact_api' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document
                        .querySelector('#csrf-form [name=csrfmiddlewaretoken]')
                        .value
                },
                body: JSON.stringify({
                    to_user: candidateId,
                    reencrypted_phone: reencrypted_phone
                })
            });
            const j = await res_contact.json();
            if (res_contact.status !== 200 || j.status !== 'ok') {
                throw new Error(j.error || 'grant ì‹¤íŒ¨');
            }

            const plainPhone = await rsaDecrypt(privateKey, res.reencrypted_phone);
            document.getElementById('contact-info').textContent = `ğŸ“ ì—°ë½ì²˜: ${plainPhone}`;
        // }
        // } catch (err) {
        //     console.error(err);
        //     alert('ì—°ë½ì²˜ ê°€ì ¸ì˜¤ê¸°/ë³µí˜¸í™” ì‹¤íŒ¨');
        // }

    })();
</script>
{% endblock %}